Title: 公网 IP 地址
Date: 2019-02-05 22:20
Modified: 2019-02-05 22:20
Slug: ext-ip-addr
Authors: Joey Huang
Summary: 在不同的网站上查询出来的外网 IP 地址不同？为什么会这样？
Status: draft

## 写在前面

我们知道，大部分时候你家的宽带，网络运营商分配给你的地址是个局域网地址。但如果你有特殊应用，需要从外网直接访问家里的网络，比如，家里装了摄像头，想从外面直接访问。此时可以向网络运营商客服申请公网 IP 地址，大部分时候，网络运营商都会满足这个需求。

可是这个公网 IP 真的可以从任何地方直接访问吗？答案是否定的，笔者就遇到过，网络运营商分配的这个公网 IP 在国内访问是没问题的，但在国外却访问不了。

## 分析过程及证据

一个明显地证据是，在笔者的电脑上，登录 `http://www.ip138.com` 查询到的公网 IP 地址和 `http://icanhazip.com` 查询到的公网 IP 地址是不一样的？为什么呢？更奇怪的是，使用 `http://icanhazip.com` 查询出来的公网 IP 地址是无法访问家庭网络的，而使用 `http://www.ip138.com` 却可以。

经过分析，得出如下结论：网络运营商分配的公网 IP 只在国内有效，在国外是无法访问的。因为网络在“出国”前会经过类似 NAT 网络的转换，在国外的客户端看到的是经过转换后的 IP 地址。这个场景和你家庭网络的场景是一样的。你的电脑在家里局域网的地址是 `192.168.0.101`，而实际上，互联网上的主机看到你的地址是诸如 `112.5.248.164` 的地址。所以说，整个国内网络就是一个大型局域网，这恐怕也是 GFW 能够建立起来的一个原因，因为所有的互联网出口都必须经过一个类似总路由器的东西。

笔者有两台虚拟主机，一台在腾讯云，在国内。另外一台在 AWS 日本，在国外。分别在腾讯云主机以及 AWS 日本主机通过 `tcpdump` 抓包可知，腾讯云主机看到的笔者的电脑的外网 IP 地址是正确的，而 AWS 日本主机上看到的则是经过“总路由器”出口转换后的 IP 地址，这个地址根本就不能反向直接访问。


