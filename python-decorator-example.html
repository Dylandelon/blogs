<!doctype html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>kamidox.com</title>
		<meta name="description" content="">
		<meta name="author" content="Joey Huang">

		<link rel="stylesheet" href="./theme/css/foundation.css" />
		<link rel="stylesheet" href="./theme/css/pygment/monokai.css" />
		<link rel="stylesheet" href="./theme/css/custom.css" />


		<link rel="shortcut icon" href="./theme/img/favicon.ico">

		<script src="./theme/js/modernizr.js"></script>

		<!-- Feeds -->


		<!-- mathjax config similar to math.stackexchange -->
		<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script>
		MathJax.Hub.Config({
		  config: ["MMLorHTML.js"],
		  extensions: ["tex2jax.js"],
		  jax: ["input/TeX"],
		  tex2jax: {
		    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
		    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
		    processEscapes: false
		  },
		  TeX: {
		    extensions: ["AMSmath.js", "AMSsymbols.js"],
		    TagSide: "right",
		    TagIndent: ".8em",
		    MultLineWidth: "85%",
		    equationNumbers: {
		      autoNumber: "AMS",
		    },
		    unicode: {
		      fonts: "STIXGeneral,'Arial Unicode MS'"
		    }
		  },
		  showProcessingMessages: false
		});
		</script>
	</head>
	<body>
		<div class="off-canvas-wrap">
			<div class="inner-wrap">
				<!-- mobile top bar to activate nav -->
				<nav class="tab-bar show-for-small">
					<section class="left-small">
						<a class="left-off-canvas-toggle menu-icon" ><span></span></a>
					</section>

					<section class="middle tab-bar-section">
						<h1 class="title">kamidox.com</h1>
					</section>
				</nav>

				<!-- mobile side bar nav -->
				<aside class="left-off-canvas-menu">
					<ul class="off-canvas-list">
							<li><a href="http://blog.kamidox.com">Home</a></li>
							<li><a href="about.html">About</a></li>

						<li><label>Categories</label></li>
							<li ><a href="./category/android.html">android</a></li>
							<li ><a href="./category/essay.html">essay</a></li>
							<li ><a href="./category/flask.html">flask</a></li>
							<li ><a href="./category/ml.html">ml</a></li>
							<li ><a href="./category/nlp.html">nlp</a></li>
							<li class="active"><a href="./category/python.html">python</a></li>
							<li ><a href="./category/tools.html">tools</a></li>
							<li ><a href="./category/werkzeug.html">werkzeug</a></li>




						<li><label>Monthly Archives</label></li>
									<li><a href="/posts/2016/02/index.html">February 2016 (1)</a></li>
									<li><a href="/posts/2016/01/index.html">January 2016 (2)</a></li>
									<li><a href="/posts/2015/12/index.html">December 2015 (10)</a></li>
									<li><a href="/posts/2015/11/index.html">November 2015 (6)</a></li>
									<li><a href="/posts/2015/10/index.html">October 2015 (2)</a></li>
									<li><a href="/posts/2015/09/index.html">September 2015 (7)</a></li>
									<li><a href="/posts/2015/08/index.html">August 2015 (1)</a></li>
									<li><a href="/posts/2015/07/index.html">July 2015 (1)</a></li>
									<li><a href="/posts/2015/05/index.html">May 2015 (1)</a></li>
									<li><a href="/posts/2015/04/index.html">April 2015 (1)</a></li>
									<li><a href="/posts/2015/03/index.html">March 2015 (3)</a></li>
									<li><a href="/posts/2015/02/index.html">February 2015 (2)</a></li>
									<li><a href="/posts/2015/01/index.html">January 2015 (2)</a></li>
									<li><a href="/posts/2014/12/index.html">December 2014 (3)</a></li>
									<li><a href="/posts/2014/11/index.html">November 2014 (4)</a></li>
									<li><a href="/posts/2014/10/index.html">October 2014 (6)</a></li>
									<li><a href="/posts/2014/09/index.html">September 2014 (1)</a></li>
									<li><a href="/posts/2014/07/index.html">July 2014 (1)</a></li>


					</ul>
				</aside>

				<!-- top bar nav -->
				<nav class="top-bar hide-for-small-only" data-topbar>
					<ul class="title-area">
						<li class="name">
							<h1><a href="./">kamidox.com</a></h1>
						</li>
					</ul>

					<section class="top-bar-section">
						<ul class="left">
								<li><a href="http://blog.kamidox.com">Home</a></li>
								<li><a href="about.html">About</a></li>

						</ul>
					</section>
				</nav>

				<!-- Main Page Content and Sidebar -->
				<section class="main-section">
					<div class="row">
						<!-- Main Content -->
						<div class="medium-9 small-12 columns" role="content">
<article>
	<h2>Python装饰器实例</h2>
	<div class="toc">
<ul>
<li><a href="#python">Python装饰器入门</a></li>
<li><a href="#flask">Flask里使用装饰器的几个例子</a><ul>
<li><a href="#setupmethod">setupmethod</a><ul>
<li><a href="#_1">需求</a></li>
<li><a href="#_2">解决方案</a></li>
<li><a href="#_3">源码分析</a></li>
</ul>
</li>
<li><a href="#locked_cached_property">locked_cached_property</a><ul>
<li><a href="#_4">需求</a></li>
<li><a href="#_5">解决方案</a></li>
<li><a href="#_6">源码分析</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h2 id="python">Python装饰器入门</h2>
<p>如果还不知道Python装饰器是什么东西，可以阅读<a href="http://www.cnblogs.com/huxi/archive/2011/03/01/1967600.html">这篇文章</a>。它深入浅出地用实例介绍了装饰器，并且还介绍内置装饰器和functools包。另外，<a href="http://www.cnblogs.com/rhcad/archive/2011/12/21/2295507.html">这篇文章</a>对装饰器支持参数传递有一些简单的示例。也可以作为一个入门的参考。</p>
<h2 id="flask">Flask里使用装饰器的几个例子</h2>
<h3 id="setupmethod">setupmethod</h3>
<h4 id="_1">需求</h4>
<p>如果web应用程序从运行起处理过一个HTTP请求，这个时候再向Flask添加route规则，则Flask在调试模式下，可以检查出一个APP的错误。为什么这是个错误呢？想像一下，如果一个web应用程序已经上线提供服务了，这个时候由于某些条件触发，向Flask又添加了一个route规则，则说明在添加这个route规则之前，向这个route发送的请求是没有接口可以处理的。</p>
<h4 id="_2">解决方案</h4>
<p>Flask定义了<code>setupmethod</code>装饰器来确保所有的初始化函数必须在web应用程序开始提供服务之前被调用。如果在已经提供服务之后被调用，则报错。</p>
<h4 id="_3">源码分析</h4>
<p><code>setupmethod</code>装饰器源码定义在<a href="https://github.com/mitsuhiko/flask/blob/0.10-maintenance/flask/app.py">app.py</a>里：</p>
<table class="codehilitetable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">setupmethod</span>(f):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;Wraps a method so that it performs a check in debug mode if the</span>
<span style="color: #BB4444; font-style: italic">    first request was already handled.</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">wrapper_func</span>(<span style="color: #AA22FF">self</span>, <span style="color: #666666">*</span>args, <span style="color: #666666">**</span>kwargs):
        <span style="color: #AA22FF; font-weight: bold">if</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>debug <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>_got_first_request:
            <span style="color: #AA22FF; font-weight: bold">raise</span> <span style="color: #D2413A; font-weight: bold">AssertionError</span>(<span style="color: #BB4444">&#39;A setup function was called after the &#39;</span>
                <span style="color: #BB4444">&#39;first request was handled.  This usually indicates a bug &#39;</span>
                <span style="color: #BB4444">&#39;in the application where a module was not imported &#39;</span>
                <span style="color: #BB4444">&#39;and decorators or other functionality was called too late.</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BB4444">&#39;</span>
                <span style="color: #BB4444">&#39;To fix this make sure to import all your view modules, &#39;</span>
                <span style="color: #BB4444">&#39;database models and everything related at a central place &#39;</span>
                <span style="color: #BB4444">&#39;before the application starts serving requests.&#39;</span>)
        <span style="color: #AA22FF; font-weight: bold">return</span> f(<span style="color: #AA22FF">self</span>, <span style="color: #666666">*</span>args, <span style="color: #666666">**</span>kwargs)
    <span style="color: #AA22FF; font-weight: bold">return</span> update_wrapper(wrapper_func, f)
</pre></div>
</td></tr></table>

<ul>
<li>Line 6：这里确保用<code>setupmethod</code>装饰的函数在被实际调用之前，都会去检查<code>self._got_first_request</code></li>
<li>Line 14：这里的<code>f(self, *args, **kwargs)</code>确保<code>setupmethod</code>装饰器可以装饰任何参数形式的函数</li>
<li>Line 15: update_wrapper是functools包提供的一个函数。用来确保被装饰的函数依然可以支持Python的反射机制</li>
</ul>
<h3 id="locked_cached_property">locked_cached_property</h3>
<h4 id="_4">需求</h4>
<p>有些属性的计算比较昂贵，如果这个属性又是非常经常被调用。那么把这个属性计算一次后，缓存起来，以确保下次访问时直接访问计算过的值。这个对性能的优化是比较有帮助的。</p>
<h4 id="_5">解决方案</h4>
<p>Flask定义了<code>locked_cached_property</code>装饰器来实现上述的需求。同时还提供了锁以保存并发线程访问的安全性。</p>
<h4 id="_6">源码分析</h4>
<p><code>locked_cached_property</code>装饰器源码定义在<a href="https://github.com/mitsuhiko/flask/blob/0.10-maintenance/flask/helpers.py">helpers.py</a>里：</p>
<table class="codehilitetable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">locked_cached_property</span>(<span style="color: #AA22FF">object</span>):
    <span style="color: #BB4444; font-style: italic">&quot;&quot;&quot;A decorator that converts a function into a lazy property.  The</span>
<span style="color: #BB4444; font-style: italic">    function wrapped is called the first time to retrieve the result</span>
<span style="color: #BB4444; font-style: italic">    and then that calculated result is used the next time you access</span>
<span style="color: #BB4444; font-style: italic">    the value.  Works like the one in Werkzeug but has a lock for</span>
<span style="color: #BB4444; font-style: italic">    thread safety.</span>
<span style="color: #BB4444; font-style: italic">    &quot;&quot;&quot;</span>

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">__init__</span>(<span style="color: #AA22FF">self</span>, func, name<span style="color: #666666">=</span><span style="color: #AA22FF">None</span>, doc<span style="color: #666666">=</span><span style="color: #AA22FF">None</span>):
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>__name__ <span style="color: #666666">=</span> name <span style="color: #AA22FF; font-weight: bold">or</span> func<span style="color: #666666">.</span>__name__
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>__module__ <span style="color: #666666">=</span> func<span style="color: #666666">.</span>__module__
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>__doc__ <span style="color: #666666">=</span> doc <span style="color: #AA22FF; font-weight: bold">or</span> func<span style="color: #666666">.</span>__doc__
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>func <span style="color: #666666">=</span> func
        <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>lock <span style="color: #666666">=</span> RLock()

    <span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">__get__</span>(<span style="color: #AA22FF">self</span>, obj, <span style="color: #AA22FF">type</span><span style="color: #666666">=</span><span style="color: #AA22FF">None</span>):
        <span style="color: #AA22FF; font-weight: bold">if</span> obj <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF">None</span>:
            <span style="color: #AA22FF; font-weight: bold">return</span> <span style="color: #AA22FF">self</span>
        <span style="color: #AA22FF; font-weight: bold">with</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>lock:
            value <span style="color: #666666">=</span> obj<span style="color: #666666">.</span>__dict__<span style="color: #666666">.</span>get(<span style="color: #AA22FF">self</span><span style="color: #666666">.</span>__name__, _missing)
            <span style="color: #AA22FF; font-weight: bold">if</span> value <span style="color: #AA22FF; font-weight: bold">is</span> _missing:
                value <span style="color: #666666">=</span> <span style="color: #AA22FF">self</span><span style="color: #666666">.</span>func(obj)
                obj<span style="color: #666666">.</span>__dict__[<span style="color: #AA22FF">self</span><span style="color: #666666">.</span>__name__] <span style="color: #666666">=</span> value
            <span style="color: #AA22FF; font-weight: bold">return</span> value
</pre></div>
</td></tr></table>

<p>Line 1: 注意这里使用类来实现装饰器，而不是我们常见的函数。<br />
Line 14: 这里用RLock来实现并发线程访问安全性。<br />
Line 16: 这里实现了<code>__get__</code>，即<code>locked_cached_property</code>是一个non-data descriptor类。</p>
<p>我们看一下<a href="https://github.com/mitsuhiko/flask/blob/0.10-maintenance/flask/app.py">app.py</a>里的<code>name</code>方法对这个装饰器是怎么使用的：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF">@locked_cached_property</span>
<span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">name</span>(<span style="color: #AA22FF">self</span>):
    <span style="color: #666666">...</span>
</pre></div>


<p>根据python decorator原理，上述代码实际上相当于下面的python代码：</p>
<table class="codehilitetable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">def</span> <span style="color: #00A000">name</span>(<span style="color: #AA22FF">self</span>):
    <span style="color: #666666">...</span>
name <span style="color: #666666">=</span> locked_cached_property(name)
</pre></div>
</td></tr></table>

<p>根据python descriptor协议，Line 3的代码实际上就是定义了一个类的只读属性。即访问<code>app.name</code>时，实际上执行的是<code>locked_cached_property.__get__</code>方法。</p>
<p>这样就实现了<code>app.name</code>属性只计算一次，且并发访问安全的需求。当然，实现这一需求的方案有很多种，Flask里使用的这种实现方法优雅且pythonic。更重要的是，它使用了AOP(Aspect-Orient Program)编程思想，提高了代码的可复用性。</p>
<div class="admonition note">
<p class="admonition-title">专业术语</p>
<p>如果你对本文使用的很多专业术语感到困惑，可阅读另外一篇<a href="./python-features.html">介绍Python特性</a>的文章。它是一个网络上一些优秀文章的资源集合。</p>
</div>
	<hr/>
	<h6>Post by <a href="./author/joey-huang.html">Joey Huang</a> under <a href="./category/python.html">python</a> on 2014-10-03(Friday) 20:20. Tags: <a href="./tag/python.html">python</a>, <a href="./tag/decorator.html">decorator</a>, </h6>
</article>

<hr/>
<div class="row">
	<div class="small-12 columns">
		<h3>Comments</h3>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_shortname = 'kamidox';
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
</div>
						</div>
						<!-- End Main Content -->
						<!-- Sidebar -->
						<aside class="medium-3 hide-for-small-only columns">
							<div class="panel">
								<h5>Places</h5>
								<ul class="side-nav">
										<li><a href="http://blog.kamidox.com/feeds/rss.xml" rel="alternate">RSS Feed</a></li>

								</ul>
							</div>


							<div class="panel">
								<h5>Categories</h5>
								<ul class="side-nav">
										<li><a href="./category/android.html">android</a></li>
										<li><a href="./category/essay.html">essay</a></li>
										<li><a href="./category/flask.html">flask</a></li>
										<li><a href="./category/ml.html">ml</a></li>
										<li><a href="./category/nlp.html">nlp</a></li>
										<li><a href="./category/python.html">python</a></li>
										<li><a href="./category/tools.html">tools</a></li>
										<li><a href="./category/werkzeug.html">werkzeug</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Tags</h5>
								<ul class="tag-cloud">
										<li class="tag-1"><a href="./tag/python.html">python</a></li>
										<li class="tag-3"><a href="./tag/pelican.html">pelican</a></li>
										<li class="tag-3"><a href="./tag/markdown.html">markdown</a></li>
										<li class="tag-3"><a href="./tag/sublime.html">sublime</a></li>
										<li class="tag-4"><a href="./tag/contacts-provider.html">contacts provider</a></li>
										<li class="tag-1"><a href="./tag/thought.html">thought</a></li>
										<li class="tag-4"><a href="./tag/nlp.html">nlp</a></li>
										<li class="tag-4"><a href="./tag/uml.html">uml</a></li>
										<li class="tag-4"><a href="./tag/patchrom.html">patchrom</a></li>
										<li class="tag-2"><a href="./tag/tools.html">tools</a></li>
										<li class="tag-4"><a href="./tag/github.html">github</a></li>
										<li class="tag-4"><a href="./tag/miui.html">miui</a></li>
										<li class="tag-2"><a href="./tag/flask.html">flask</a></li>
										<li class="tag-2"><a href="./tag/android.html">android</a></li>
										<li class="tag-4"><a href="./tag/socketserver.html">SocketServer</a></li>
										<li class="tag-1"><a href="./tag/machine-learning.html">machine-learning</a></li>
										<li class="tag-4"><a href="./tag/contacts.html">contacts</a></li>
										<li class="tag-4"><a href="./tag/wekzeug.html">wekzeug</a></li>
										<li class="tag-4"><a href="./tag/decorator.html">decorator</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Monthly Archives</h5>
								<ul class="side-nav">
											<li><a href="/posts/2016/02/index.html">February 2016 (1)</a></li>
											<li><a href="/posts/2016/01/index.html">January 2016 (2)</a></li>
											<li><a href="/posts/2015/12/index.html">December 2015 (10)</a></li>
											<li><a href="/posts/2015/11/index.html">November 2015 (6)</a></li>
											<li><a href="/posts/2015/10/index.html">October 2015 (2)</a></li>
											<li><a href="/posts/2015/09/index.html">September 2015 (7)</a></li>
											<li><a href="/posts/2015/08/index.html">August 2015 (1)</a></li>
											<li><a href="/posts/2015/07/index.html">July 2015 (1)</a></li>
											<li><a href="/posts/2015/05/index.html">May 2015 (1)</a></li>
											<li><a href="/posts/2015/04/index.html">April 2015 (1)</a></li>
											<li><a href="/posts/2015/03/index.html">March 2015 (3)</a></li>
											<li><a href="/posts/2015/02/index.html">February 2015 (2)</a></li>
											<li><a href="/posts/2015/01/index.html">January 2015 (2)</a></li>
											<li><a href="/posts/2014/12/index.html">December 2014 (3)</a></li>
											<li><a href="/posts/2014/11/index.html">November 2014 (4)</a></li>
											<li><a href="/posts/2014/10/index.html">October 2014 (6)</a></li>
											<li><a href="/posts/2014/09/index.html">September 2014 (1)</a></li>
											<li><a href="/posts/2014/07/index.html">July 2014 (1)</a></li>
								</ul>
							</div>

						</aside>
						<!-- End Sidebar -->
					</div>

					<!-- Footer -->
					<footer class="row">
						<div class="medium-9 small-12">
							<hr/>
							<p class="text-center">Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://foundation.zurb.com/">Zurb Foundation</a>. Theme by <a href="http://hamaluik.com">Kenton Hamaluik</a>.
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253471695'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1253471695%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
							</p>
						</div>
					</footer>
					<!-- End Footer -->
				</section>
				<a class="exit-off-canvas"></a>
			</div><!--off-canvas inner-->
		</div><!--off-canvas wrap-->

		<script src="./theme/js/jquery.js"></script>
		<script src="./theme/js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>
	</body>
</html>