<!doctype html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>kamidox.com</title>
		<meta name="description" content="">
		<meta name="author" content="Joey Huang">

		<link rel="stylesheet" href="./theme/css/foundation.css" />
		<link rel="stylesheet" href="./theme/css/pygment/monokai.css" />
		<link rel="stylesheet" href="./theme/css/custom.css" />


		<link rel="shortcut icon" href="./theme/img/favicon.ico">

		<script src="./theme/js/modernizr.js"></script>

		<!-- Feeds -->


		<!-- mathjax config similar to math.stackexchange -->
		<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script>
		MathJax.Hub.Config({
		  config: ["MMLorHTML.js"],
		  extensions: ["tex2jax.js"],
		  jax: ["input/TeX"],
		  tex2jax: {
		    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
		    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
		    processEscapes: false
		  },
		  TeX: {
		    extensions: ["AMSmath.js", "AMSsymbols.js"],
		    TagSide: "right",
		    TagIndent: ".8em",
		    MultLineWidth: "85%",
		    equationNumbers: {
		      autoNumber: "AMS",
		    },
		    unicode: {
		      fonts: "STIXGeneral,'Arial Unicode MS'"
		    }
		  },
		  showProcessingMessages: false
		});
		</script>
	</head>
	<body>
		<div class="off-canvas-wrap">
			<div class="inner-wrap">
				<!-- mobile top bar to activate nav -->
				<nav class="tab-bar show-for-small">
					<section class="left-small">
						<a class="left-off-canvas-toggle menu-icon" ><span></span></a>
					</section>

					<section class="middle tab-bar-section">
						<h1 class="title">kamidox.com</h1>
					</section>
				</nav>

				<!-- mobile side bar nav -->
				<aside class="left-off-canvas-menu">
					<ul class="off-canvas-list">
							<li><a href="http://blog.kamidox.com">Home</a></li>
							<li><a href="http://blog.kamidox.com/about.html">About</a></li>

						<li><label>Categories</label></li>
							<li ><a href="./category/android.html">android</a></li>
							<li ><a href="./category/essay.html">essay</a></li>
							<li ><a href="./category/flask.html">flask</a></li>
							<li ><a href="./category/ml.html">ml</a></li>
							<li ><a href="./category/nlp.html">nlp</a></li>
							<li ><a href="./category/python.html">python</a></li>
							<li ><a href="./category/tools.html">tools</a></li>
							<li class="active"><a href="./category/weapp.html">weapp</a></li>
							<li ><a href="./category/web.html">web</a></li>
							<li ><a href="./category/werkzeug.html">werkzeug</a></li>




						<li><label>Monthly Archives</label></li>
									<li><a href="/posts/2017/05/index.html">May 2017 (2)</a></li>
									<li><a href="/posts/2017/04/index.html">April 2017 (1)</a></li>
									<li><a href="/posts/2017/02/index.html">February 2017 (1)</a></li>
									<li><a href="/posts/2017/01/index.html">January 2017 (1)</a></li>
									<li><a href="/posts/2016/12/index.html">December 2016 (2)</a></li>
									<li><a href="/posts/2016/11/index.html">November 2016 (3)</a></li>
									<li><a href="/posts/2016/10/index.html">October 2016 (1)</a></li>
									<li><a href="/posts/2016/09/index.html">September 2016 (1)</a></li>
									<li><a href="/posts/2016/03/index.html">March 2016 (2)</a></li>
									<li><a href="/posts/2016/02/index.html">February 2016 (2)</a></li>
									<li><a href="/posts/2016/01/index.html">January 2016 (2)</a></li>
									<li><a href="/posts/2015/12/index.html">December 2015 (10)</a></li>
									<li><a href="/posts/2015/11/index.html">November 2015 (6)</a></li>
									<li><a href="/posts/2015/10/index.html">October 2015 (2)</a></li>
									<li><a href="/posts/2015/09/index.html">September 2015 (7)</a></li>
									<li><a href="/posts/2015/08/index.html">August 2015 (1)</a></li>
									<li><a href="/posts/2015/07/index.html">July 2015 (1)</a></li>
									<li><a href="/posts/2015/05/index.html">May 2015 (1)</a></li>
									<li><a href="/posts/2015/04/index.html">April 2015 (1)</a></li>
									<li><a href="/posts/2015/03/index.html">March 2015 (3)</a></li>
									<li><a href="/posts/2015/02/index.html">February 2015 (2)</a></li>
									<li><a href="/posts/2015/01/index.html">January 2015 (2)</a></li>
									<li><a href="/posts/2014/12/index.html">December 2014 (3)</a></li>
									<li><a href="/posts/2014/11/index.html">November 2014 (4)</a></li>
									<li><a href="/posts/2014/10/index.html">October 2014 (6)</a></li>
									<li><a href="/posts/2014/09/index.html">September 2014 (1)</a></li>
									<li><a href="/posts/2014/07/index.html">July 2014 (1)</a></li>


					</ul>
				</aside>

				<!-- top bar nav -->
				<nav class="top-bar hide-for-small-only" data-topbar>
					<ul class="title-area">
						<li class="name">
							<h1><a href="./">kamidox.com</a></h1>
						</li>
					</ul>

					<section class="top-bar-section">
						<ul class="left">
								<li><a href="http://blog.kamidox.com">Home</a></li>
								<li><a href="http://blog.kamidox.com/about.html">About</a></li>

						</ul>
					</section>
				</nav>

				<!-- Main Page Content and Sidebar -->
				<section class="main-section">
					<div class="row">
						<!-- Main Content -->
						<div class="medium-9 small-12 columns" role="content">
<article>
	<h2>微信小程序原理</h2>
	<h2 id="_1">写在前面</h2>
<p>微信小程序使用了前端技术栈 JavaScript/WXML/WXSS。但和常规的前端开发又有一些区别：</p>
<ul>
<li>JavaScript: 微信小程序的 JavaScript 运行环境即不是 Browser 也不是 Node.js。它运行在微信 App 的上下文中，不能操作 Browser context 下的 DOM，也不能通过 Node.js 相关接口访问操作系统 API。所以，严格意义来讲，微信小程序并不是 Html5，虽然开发过程和用到的技术栈和 Html5 是相通的。</li>
<li>WXML: 作为微信小程序的展示层，并不是使用 Html，而是自己发明的基于 XML 语法的描述。</li>
<li>WXSS: 用来修饰展示层的样式。官方的描述是 “ WXSS (WeiXin Style Sheets) 是一套样式语言，用于描述 WXML 的组件样式。WXSS 用来决定 WXML 的组件应该怎么显示。” “我们的 WXSS 具有 CSS 大部分特性&hellip;我们对 CSS 进行了扩充以及修改。”基于 CSS2 还是 CSS3？大部分是哪些部分？是否支持 CSS3 里的动画？不得而知。</li>
</ul>
<p>在微信小程序官方文档上，有下面这段话：</p>
<blockquote>
<p>微信小程序运行在三端：iOS、Android 和 用于调试的开发者工具</p>
<ul>
<li>在 iOS 上，小程序的 javascript 代码是运行在 JavaScriptCore 中</li>
<li>在 Android 上，小程序的 javascript 代码是通过 X5 内核来解析</li>
<li>在 开发工具上， 小程序的 javascript 代码是运行在 nwjs（chrome内核） 中</li>
</ul>
</blockquote>
<p>我们先从开发工具谈起。</p>
<h2 id="_2">开发工具</h2>
<p>小程序的 javascript 代码运行在 nwjs 中。nwjs 是什么鬼呢？官方介绍是这样写的：</p>
<blockquote>
<p>NW.js (previously known as node-webkit) lets you call all Node.js modules directly from DOM and enables a new way of writing applications with all Web technologies.</p>
</blockquote>
<p><a href="http://nwjs.io">nwjs</a> 合并 Browser 和 Node.js 的运行时，可以使用前端开发技术来开发跨平台的应用程序。借助 Node.js 访问操作系统原生 API 的能力，可以开发中跨平台的应用程序。微信小程序开发工具就是使用 nwjs 开发的。如果你是 Mac 用户，进入目录 <code>/Applications/wechatwebdevtools.app/Contents/Resources/app.nw/app</code> 可以看到开发工具的实现代码，当然代码是经过混淆的。网上流行的破解版本开发工具原理上就是修改这里面的代码。</p>
<p>与此类似的，一个更火的项目是 <a href="http://electron.atom.io">Electron</a>，由 GitHub 推出的，它也是把 Browser 和 Node.js 结合，用来开发跨平台的应用程序。程序员们应该听说过 <a href="https://atom.io">Atom</a> 这个编辑器界的后起之秀。包括微软拥抱开源社区的编辑器 <a href="http://code.visualstudio.com">vscode</a> 也是使用 Electron 开发的。</p>
<h3 id="electron-vs-nwjs">Electron vs nwjs</h3>
<p>这两个平台有什么区别？为什么微信选择 nwjs 呢？我们不妨猜一猜。</p>
<p>从技术角度来讲：</p>
<ul>
<li>应用程序入口不同：Electron 入口是一个 javascript 脚本，脚本里要自己负责创建浏览器窗口，加载 html 页面。而 nwjs 的入口就是一个 html 页面，框架自己会创建浏览器窗口来显示这个 html 页面。</li>
<li>Node.js 集成方式不同：Electron 直接使用 Node.js 的共享库，不需要修改 Chromium 代码。而 nwjs 为了集成 Node.js ，需要修改 Chromium 代码，以便在浏览器里能通过 Node.js 访问系统原生 API。</li>
<li>Multi-Context: nwjs 有多个上下文，一个是浏览器的上下文，用来访问 Browser 相关 API，比如操作 DOM ，另外一个是 Node 上下文，用来访问操作系统 API。Electron 没有使用多个上下文，对开发者更友好。</li>
</ul>
<p>从应用角度来讲：</p>
<ul>
<li>打包后的文件大小：Electron 打包后文件会比 nwjs 小不少。一个 18M 的程序，使用 Electron 打包后是 117M，而使用 nwjs 打包后的程序是 220M。微信小程序开发工具打包后是 219M (v0.10.102800)。没有亲测，评价来源参考文档。</li>
<li>代码保护：Electron 只支持代码混淆来保护，而 nwjs 把核心代码放在 V8 引擎里，不但可以保护代码，还可以提高执行效率。</li>
<li>开源社区活跃度：Electron 应该是完胜的。看看<a href="http://electron.atom.io/apps/">使用 Electron 构建的应用程序</a>就知道了。而据说 nwjs 的开发文档有些都没有及时更新。</li>
<li>应用程序启动时间：Electron 会稍微快一点。没有亲测，评价来源参考文档。</li>
</ul>
<p>从这个分析猜测，微信选择 nwjs 的原因可能是出于代码保护。毕竟开发工具可以上传小程序，有些接口和数据需要比较严密的保护。哪位大牛可以挖挖看哪些代码被保护起来了。</p>
<h2 id="_3">真机运行环境</h2>
<p>下面内容完全是猜测的，如有言中，实属运气。</p>
<p>微信小程序的运行环境应该更类似 ReactNative 之类，而不是纯 Html5。两者最大的不同在于，ReactNative 的界面是由原生控件渲染出来的，而 Html5 的界面是由浏览器内核渲染出来的。两者在性能上有较大的差异，感兴趣的可以参阅我的另外一篇文章<a href="http://www.jianshu.com/p/2b4926fa45df">《跨平台 App 开发技术方案汇总》</a>。</p>
<p>原理上，小程序是如何在微信 App 里运行的呢？</p>
<ul>
<li>微信 App 里包含 javascript 运行引擎。</li>
<li>微信 App 里包含了 WXML/WXSS 处理引擎，最终会把界面翻译成系统原生的控件，并展示出来。这样做的目的是为了提供和原生 App 性能相当的用户体验。</li>
</ul>
<p>我们来意淫一下小程序加载运行的过程：</p>
<ul>
<li>用户点击打开一个小程序</li>
<li>微信 App 从微信服务器下载这个小程序</li>
<li>分析 <code>app.json</code> 得到应用程序的配置信息（导航栏，窗口样式，包含的页面列表等）</li>
<li>加载并运行 <code>app.js</code></li>
<li>加载并显示在 <code>app.json</code> 里配置的第一个页面</li>
</ul>
<p>这个只是从开发者眼中看到的一个简化版的过程，实际过程应该比这要复杂得多，涉及到浏览器线程（就是运行我们的逻辑层代码 app.js 等的线程）和 AppService 线程之间的交互。从官方网站上的一个图片可以看出端倪：</p>
<p><img alt="生命周期" src="https://mp.weixin.qq.com/debug/wxadoc/dev/image/mina-lifecycle.png" /></p>
<p>至于微信 App 是如何与小程序的逻辑层 javascript 交互的呢？可以简单地归纳如下：</p>
<p>JavaScript 是脚本语言，可以在运行时解释并执行。微信 App 里包含了一个 JavaScript 引擎，由它来负责执行逻辑层的 JavaScript 代码。那么 JavaScript 调用的小程序相关 API 怎么实现的呢？答案是最终会被翻译成实现在微信 App 里的原生接口。比如开发者调用 <code>wx.getLocation(OBJECT)</code> 获取当前地理位置，微信 App 里的 JavaScript 引擎在执行这个代码时，会去调用微信 App 里实现的原生接口来获取地理位置坐标。</p>
<p>感兴趣的朋友可以阅读我之前推荐过的一篇文章<a href="http://www.jianshu.com/p/978c4bd3a759">《React Native 从入门到原理》</a>。文章分析的虽然是 ReactNative，但实际上原理是相通的。</p>
<h2 id="_4">总结</h2>
<p>微信小程序最大的好处是不需要做设备适配，只要微信能运行，小程序就能运行。小程序虽然是一个封闭形态下的前端开发技术，但借助微信的巨大影响力，几乎所有人都在往里面冲。微信小程序太火了，内测火，公测更火。内测刚出来，就有人用微信小程序实现了商城，并开源。感叹一下：你的热情，就像一把火，燃烧了整个沙漠。</p>
<p>作为开发者，提几个不足：</p>
<ol>
<li>不支持从 node_modules 中加载模块。这样无形中就把 npm 排除在外了。从开发生态角度，这个应该是微信小程序下一步要重点解决的问题吧。</li>
<li>开发工具自带的代码编辑器还是太简陋了。不知道为什么微信要重复发明轮子。理论上，给流行的代码编辑器 (sublime/atom/vscode etc.) 开发个插件。然后用户直接到小程序后台上传提交审核就好了。程序员是挑剔到近乎偏执的物种，代码编辑器又是程序员时刻打交道的工具，要做好实属不易。</li>
</ol>
<h2 id="_5">参考文档</h2>
<ol>
<li>https://github.com/electron/electron/blob/master/docs/development/atom-shell-vs-node-webkit.md</li>
<li>https://www.akawebdesign.com/2015/05/06/electron-vs-nwjs/</li>
<li>https://www.akawebdesign.com/2015/11/02/electron-vs-nwjs-part-2/</li>
</ol>
	<hr/>
	<h6>Post by <a href="./author/joey-huang.html">Joey Huang</a> under <a href="./category/weapp.html">weapp</a> on 2016-11-05(Saturday) 07:52. Tags: <a href="./tag/weapp.html">weapp</a>, </h6>
</article>

<hr/>
<div class="row">
	<div class="small-12 columns">
		<h3>Comments</h3>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_shortname = 'kamidox';
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
</div>
						</div>
						<!-- End Main Content -->
						<!-- Sidebar -->
						<aside class="medium-3 hide-for-small-only columns">
							<div class="panel">
								<h5>Places</h5>
								<ul class="side-nav">
										<li><a href="http://blog.kamidox.com/feeds/rss.xml" rel="alternate">RSS Feed</a></li>

								</ul>
							</div>


							<div class="panel">
								<h5>Categories</h5>
								<ul class="side-nav">
										<li><a href="./category/android.html">android</a></li>
										<li><a href="./category/essay.html">essay</a></li>
										<li><a href="./category/flask.html">flask</a></li>
										<li><a href="./category/ml.html">ml</a></li>
										<li><a href="./category/nlp.html">nlp</a></li>
										<li><a href="./category/python.html">python</a></li>
										<li><a href="./category/tools.html">tools</a></li>
										<li><a href="./category/weapp.html">weapp</a></li>
										<li><a href="./category/web.html">web</a></li>
										<li><a href="./category/werkzeug.html">werkzeug</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Tags</h5>
								<ul class="tag-cloud">
										<li class="tag-4"><a href="./tag/contacts-provider.html">contacts provider</a></li>
										<li class="tag-4"><a href="./tag/ebook.html">ebook</a></li>
										<li class="tag-4"><a href="./tag/miui.html">miui</a></li>
										<li class="tag-1"><a href="./tag/thought.html">thought</a></li>
										<li class="tag-3"><a href="./tag/pelican.html">pelican</a></li>
										<li class="tag-4"><a href="./tag/socketserver.html">SocketServer</a></li>
										<li class="tag-2"><a href="./tag/markdown.html">markdown</a></li>
										<li class="tag-2"><a href="./tag/weapp.html">weapp</a></li>
										<li class="tag-4"><a href="./tag/wekzeug.html">wekzeug</a></li>
										<li class="tag-4"><a href="./tag/github.html">github</a></li>
										<li class="tag-1"><a href="./tag/python.html">python</a></li>
										<li class="tag-1"><a href="./tag/machine-learning.html">machine-learning</a></li>
										<li class="tag-4"><a href="./tag/web.html">web</a></li>
										<li class="tag-4"><a href="./tag/nlp.html">nlp</a></li>
										<li class="tag-2"><a href="./tag/android.html">android</a></li>
										<li class="tag-4"><a href="./tag/react.html">react</a></li>
										<li class="tag-4"><a href="./tag/uml.html">uml</a></li>
										<li class="tag-2"><a href="./tag/flask.html">flask</a></li>
										<li class="tag-2"><a href="./tag/tools.html">tools</a></li>
										<li class="tag-4"><a href="./tag/contacts.html">contacts</a></li>
										<li class="tag-4"><a href="./tag/decorator.html">decorator</a></li>
										<li class="tag-4"><a href="./tag/patchrom.html">patchrom</a></li>
										<li class="tag-3"><a href="./tag/sublime.html">sublime</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Monthly Archives</h5>
								<ul class="side-nav">
											<li><a href="/posts/2017/05/index.html">May 2017 (2)</a></li>
											<li><a href="/posts/2017/04/index.html">April 2017 (1)</a></li>
											<li><a href="/posts/2017/02/index.html">February 2017 (1)</a></li>
											<li><a href="/posts/2017/01/index.html">January 2017 (1)</a></li>
											<li><a href="/posts/2016/12/index.html">December 2016 (2)</a></li>
											<li><a href="/posts/2016/11/index.html">November 2016 (3)</a></li>
											<li><a href="/posts/2016/10/index.html">October 2016 (1)</a></li>
											<li><a href="/posts/2016/09/index.html">September 2016 (1)</a></li>
											<li><a href="/posts/2016/03/index.html">March 2016 (2)</a></li>
											<li><a href="/posts/2016/02/index.html">February 2016 (2)</a></li>
											<li><a href="/posts/2016/01/index.html">January 2016 (2)</a></li>
											<li><a href="/posts/2015/12/index.html">December 2015 (10)</a></li>
											<li><a href="/posts/2015/11/index.html">November 2015 (6)</a></li>
											<li><a href="/posts/2015/10/index.html">October 2015 (2)</a></li>
											<li><a href="/posts/2015/09/index.html">September 2015 (7)</a></li>
											<li><a href="/posts/2015/08/index.html">August 2015 (1)</a></li>
											<li><a href="/posts/2015/07/index.html">July 2015 (1)</a></li>
											<li><a href="/posts/2015/05/index.html">May 2015 (1)</a></li>
											<li><a href="/posts/2015/04/index.html">April 2015 (1)</a></li>
											<li><a href="/posts/2015/03/index.html">March 2015 (3)</a></li>
											<li><a href="/posts/2015/02/index.html">February 2015 (2)</a></li>
											<li><a href="/posts/2015/01/index.html">January 2015 (2)</a></li>
											<li><a href="/posts/2014/12/index.html">December 2014 (3)</a></li>
											<li><a href="/posts/2014/11/index.html">November 2014 (4)</a></li>
											<li><a href="/posts/2014/10/index.html">October 2014 (6)</a></li>
											<li><a href="/posts/2014/09/index.html">September 2014 (1)</a></li>
											<li><a href="/posts/2014/07/index.html">July 2014 (1)</a></li>
								</ul>
							</div>

						</aside>
						<!-- End Sidebar -->
					</div>

					<!-- Footer -->
					<footer class="row">
						<div class="medium-9 small-12">
							<hr/>
							<p class="text-center">Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://foundation.zurb.com/">Zurb Foundation</a>. Theme by <a href="http://hamaluik.com">Kenton Hamaluik</a>.
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253471695'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1253471695%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
							</p>
						</div>
					</footer>
					<!-- End Footer -->
				</section>
				<a class="exit-off-canvas"></a>
			</div><!--off-canvas inner-->
		</div><!--off-canvas wrap-->

		<script src="./theme/js/jquery.js"></script>
		<script src="./theme/js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>
	</body>
</html>