<!doctype html>
<html class="no-js" lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>kamidox.com</title>
		<meta name="description" content="">
		<meta name="author" content="Joey Huang">

		<link rel="stylesheet" href="./theme/css/foundation.css" />
		<link rel="stylesheet" href="./theme/css/pygment/monokai.css" />
		<link rel="stylesheet" href="./theme/css/custom.css" />


		<link rel="shortcut icon" href="./theme/img/favicon.ico">

		<script src="./theme/js/modernizr.js"></script>

		<!-- Feeds -->


		<!-- mathjax config similar to math.stackexchange -->
		<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script>
		MathJax.Hub.Config({
		  config: ["MMLorHTML.js"],
		  extensions: ["tex2jax.js"],
		  jax: ["input/TeX"],
		  tex2jax: {
		    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
		    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
		    processEscapes: false
		  },
		  TeX: {
		    extensions: ["AMSmath.js", "AMSsymbols.js"],
		    TagSide: "right",
		    TagIndent: ".8em",
		    MultLineWidth: "85%",
		    equationNumbers: {
		      autoNumber: "AMS",
		    },
		    unicode: {
		      fonts: "STIXGeneral,'Arial Unicode MS'"
		    }
		  },
		  showProcessingMessages: false
		});
		</script>
	</head>
	<body>
		<div class="off-canvas-wrap">
			<div class="inner-wrap">
				<!-- mobile top bar to activate nav -->
				<nav class="tab-bar show-for-small">
					<section class="left-small">
						<a class="left-off-canvas-toggle menu-icon" ><span></span></a>
					</section>

					<section class="middle tab-bar-section">
						<h1 class="title">kamidox.com</h1>
					</section>
				</nav>

				<!-- mobile side bar nav -->
				<aside class="left-off-canvas-menu">
					<ul class="off-canvas-list">
							<li><a href="http://blog.kamidox.com">Home</a></li>
							<li><a href="http://blog.kamidox.com/about.html">About</a></li>

						<li><label>Categories</label></li>
							<li ><a href="./category/android.html">android</a></li>
							<li ><a href="./category/essay.html">essay</a></li>
							<li ><a href="./category/flask.html">flask</a></li>
							<li class="active"><a href="./category/ml.html">ml</a></li>
							<li ><a href="./category/nlp.html">nlp</a></li>
							<li ><a href="./category/python.html">python</a></li>
							<li ><a href="./category/tools.html">tools</a></li>
							<li ><a href="./category/weapp.html">weapp</a></li>
							<li ><a href="./category/web.html">web</a></li>
							<li ><a href="./category/werkzeug.html">werkzeug</a></li>




						<li><label>Monthly Archives</label></li>
									<li><a href="/posts/2018/03/index.html">March 2018 (1)</a></li>
									<li><a href="/posts/2017/05/index.html">May 2017 (2)</a></li>
									<li><a href="/posts/2017/04/index.html">April 2017 (1)</a></li>
									<li><a href="/posts/2017/02/index.html">February 2017 (1)</a></li>
									<li><a href="/posts/2017/01/index.html">January 2017 (1)</a></li>
									<li><a href="/posts/2016/12/index.html">December 2016 (2)</a></li>
									<li><a href="/posts/2016/11/index.html">November 2016 (3)</a></li>
									<li><a href="/posts/2016/10/index.html">October 2016 (1)</a></li>
									<li><a href="/posts/2016/09/index.html">September 2016 (1)</a></li>
									<li><a href="/posts/2016/03/index.html">March 2016 (2)</a></li>
									<li><a href="/posts/2016/02/index.html">February 2016 (2)</a></li>
									<li><a href="/posts/2016/01/index.html">January 2016 (2)</a></li>
									<li><a href="/posts/2015/12/index.html">December 2015 (10)</a></li>
									<li><a href="/posts/2015/11/index.html">November 2015 (6)</a></li>
									<li><a href="/posts/2015/10/index.html">October 2015 (2)</a></li>
									<li><a href="/posts/2015/09/index.html">September 2015 (7)</a></li>
									<li><a href="/posts/2015/08/index.html">August 2015 (1)</a></li>
									<li><a href="/posts/2015/07/index.html">July 2015 (1)</a></li>
									<li><a href="/posts/2015/05/index.html">May 2015 (1)</a></li>
									<li><a href="/posts/2015/04/index.html">April 2015 (1)</a></li>
									<li><a href="/posts/2015/03/index.html">March 2015 (3)</a></li>
									<li><a href="/posts/2015/02/index.html">February 2015 (2)</a></li>
									<li><a href="/posts/2015/01/index.html">January 2015 (2)</a></li>
									<li><a href="/posts/2014/12/index.html">December 2014 (3)</a></li>
									<li><a href="/posts/2014/11/index.html">November 2014 (4)</a></li>
									<li><a href="/posts/2014/10/index.html">October 2014 (6)</a></li>
									<li><a href="/posts/2014/09/index.html">September 2014 (1)</a></li>
									<li><a href="/posts/2014/07/index.html">July 2014 (1)</a></li>


					</ul>
				</aside>

				<!-- top bar nav -->
				<nav class="top-bar hide-for-small-only" data-topbar>
					<ul class="title-area">
						<li class="name">
							<h1><a href="./">kamidox.com</a></h1>
						</li>
					</ul>

					<section class="top-bar-section">
						<ul class="left">
								<li><a href="http://blog.kamidox.com">Home</a></li>
								<li><a href="http://blog.kamidox.com/about.html">About</a></li>

						</ul>
					</section>
				</nav>

				<!-- Main Page Content and Sidebar -->
				<section class="main-section">
					<div class="row">
						<!-- Main Content -->
						<div class="medium-9 small-12 columns" role="content">
<article>
	<h2>利用朴素贝叶斯算法进行文档分类</h2>
	<p>在 scikit-learn 里，朴素贝叶斯算法在 <code>sklearn.naive_bayes</code> 包里实现，包含了本章介绍的几种典型的概率分布算法。其中 <code>GaussianNB</code> 实现了高斯分布的朴素贝叶斯算法，<code>MultinomialNB</code> 实现了多项式分布的朴素贝叶斯算法，<code>BernoulliNB</code> 实现了伯努利分布的朴素贝叶斯算法。本文我们用 <code>MultinomialNB</code> 来实现文档自动分类。如果你不熟悉朴素贝叶斯算法，可参阅笔者的另外一篇博客<a href="http://blog.kamidox.com/naive-bayes.html">零基础学习朴素贝叶斯算法</a>。</p>
<h2 id="1">1 获取数据集</h2>
<p>本节使用的数据集来自 mlcomp.org 上的 <a href="http://mlcomp.org/datasets/379">20news-18828</a>，免费注册后即可下载。下载完数据集后，可以解压解压到 <code>~/code/datasets/mlcomp/</code> 目录下，解压后会在 <code>~/code/datasets/mlcomp</code> 下生成一个名为 <code>379</code> 的目录，其目录下包含三个子目录和一个名为 <code>metadata</code> 的介绍文件：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #B8860B">$ </span><span style="color: #AA22FF">cd</span> ~/code/datasets/mlcomp
<span style="color: #B8860B">$ </span>ls 379
metadata  raw  <span style="color: #AA22FF">test  </span>train
</pre></div>


<p>我们将使用 <code>train</code> 子目录下的文档进行模型训练，然后使用 <code>test</code> 子目录下的文档进行模型测试。<code>train</code> 子目录下包含 20 个子目录，每个子目录代表一种文档的类型，子目录下的所有文档都是属于目录名称所标识的文档类型。读者朋友可以随意浏览数据集，以便对数据集有一个感性的认识。比如 <code>datasets/mlcomp/379/train/rec.autos/6652-103421</code> ，这是一个纯广本文件，可以使用任何文本编辑器打开。这是一个讨论汽车主题的帖子：</p>
<blockquote>
<p>Hahahahahaha.  <em>gasp</em>  <em>pant</em>  Hm, I&rsquo;m not sure whether the above<br />
was just a silly remark or a serious remark.  But in case there are<br />
some misconceptions, I think Henry Robertson hasn&rsquo;t updated his data<br />
file on Korea since&hellip;mid 1970s.  Owning a car in Korea is no longer<br />
a luxury.  Most middle class people in Korea can afford a car and do<br />
have at least one car.  The problem in Korea, especially in Seoul, is<br />
that there are just so many privately-owned cars, as well as taxis and<br />
buses, the rush-hour has become a 24 hour phenomenon and that there is<br />
no place to park.  Last time I heard, back in January, the Kim Administration<br />
wanted to legislate a law requireing a potential car owner to provide<br />
his or her own parking area, just like they do in Japan.</p>
<p>Also, Henry would be glad to know that Hyundai isn&rsquo;t the only<br />
car manufacturer in Korea.  Daewoo has always manufactured cars and<br />
I believe Kia is back in business as well.  Imported cars, such as<br />
Mercury Sable are becoming quite popular as well, though they are still<br />
quite expensive.</p>
<p>Finally, please ignore Henry&rsquo;s posting about Korean politics<br />
and bureaucracy.  He&rsquo;s quite uninformed.</p>
</blockquote>
<h2 id="2">2 文档的数学表达</h2>
<p>怎么样把一个文档表达为计算机可以理解并处理的信息？这是自然语言处理里的一个重要课题，完整的内容可以写成鸿篇巨著。本节简单介绍 TF-IDF 的原理，以便读者更好地理解本文介绍的实例。</p>
<p>TF-IDF 是一种统计方法，用以评估一个词语对于一份文档的重要程度。TF 表示<strong>词频</strong> (Term Frequency)，对一份文档而言，词频为特定词语在这篇文档里出现的次数除以文档的词语总数。比如一篇文档总共有 1000 个词，其中 “朴素贝叶斯” 出现了 5 次，“的” 出现了 25 次，“应用” 出现了 12 次，那么它们的词频分别是 0.005, 0.025, 0.012。</p>
<p>IDF 表示一个词的<strong>逆向文档频率指数</strong> (Inverse Document Frequency) ，可以由总文档数目除以包含该词语的文档的数目，再将得到的商取对数得到，它表达的是词语的权重指数。比如，我们的数据集总共有 10000 篇文档，其中 “朴素贝叶斯” 只出现在 10 篇文档中，则其权重指数 $IDF = log(\frac {10000} {10}) = 3$ 。“的” 在所有的文档中都出现，则其权重指数 $IDF = log(1) = 0$ 。“应用” 在 1000 篇文档中出现，则其权重指数 $IDF = log(\frac {10000} {1000}) = 1$ 。</p>
<p>计算出每个词的词频和权重指数后，两者相乘，即可得到这个词在文档中的重要程度。词语的重要性随着它在文档中出现的次数成正比增加，但同时会随着它在语料库中出现的频率成反比下降。关于 TF-IDF 在搜索引擎上的应用，可参阅吴军老师的《数学之美》里的《如何确定网页和查询的相关性》一文。</p>
<p>有了 TF-IDF 这个工具，我们就可以把一篇文档转换为一个向量。首先，可以从我们的数据集（在自然语言处理领域，也称为 corpus ，即语料库）里提取出所有出现的词语，我们称为<strong>词典</strong>。假设词典里总共有 10000 个词语，则每个文档都可转化为一个 10000 维的向量。其次，针对我们要转换的文档里出现的每个词语，都去计算其 TF-IDF 的值，并把这个值填入文档向量里，这个词所对应的元素上。这样就完成了把一篇文档转换为一个向量的过程。一个文档往往只会由词典里的一小部分词语构成，这就意味着这个这个向量里大部分元素都是零。</p>
<p>所幸，上述过程我们不需要自己写代码完成，scikit-learn 软件包里实现了把文档转换为向量的过程。首先，我们把训练用的语料库读入内存：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">time</span> <span style="color: #AA22FF; font-weight: bold">import</span> time
<span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.datasets</span> <span style="color: #AA22FF; font-weight: bold">import</span> load_files

<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;loading train dataset ...&quot;</span>)
t <span style="color: #666666">=</span> time()
news_train <span style="color: #666666">=</span> load_files(<span style="color: #BB4444">&#39;datasets/mlcomp/379/train&#39;</span>)
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;summary: {0} documents in {1} categories.&quot;</span><span style="color: #666666">.</span>format(
    <span style="color: #AA22FF">len</span>(news_train<span style="color: #666666">.</span>data), <span style="color: #AA22FF">len</span>(news_train<span style="color: #666666">.</span>target_names)))
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;done in {0} seconds&quot;</span><span style="color: #666666">.</span>format(time() <span style="color: #666666">-</span> t))
</pre></div>


<p>我们的代码保存在 <code>~/code/</code> 目录下，其相对路径 <code>datasets/mlcomp/379/train</code> 目录下放的就是我们的语料库，其中包含 20 个子目录，每个子目录的名字表示的是文档的类别，子目录下包含这种类别的所有文档。<a href="http://scikit-learn.org/stable/modules/generated/sklearn.datasets.load_files.html">load_files()</a> 函数会从这个目录里把所有的文档都读入内存，并且自动根据所在的子目录名称打上标签。其中，<code>news_train.data</code> 是一个数组，里面包含了所有文档的文本信息。<code>news_train.target</code> 也是一个数组，包含了所有文档所属的类别，而 <code>news_train.target_names</code> 则是的类别的名称，因此，如果我们想知道第一篇文档所属的类别名称，只需要通过代码 <code>news_train.target_names[news_train.target[0]]</code> 即可得到。</p>
<p>上述代码在笔者电脑上的输出是：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">loading train dataset <span style="color: #666666">...</span>
summary: <span style="color: #666666">13180</span> documents <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">20</span> categories<span style="color: #666666">.</span>
done <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0.212177991867</span> seconds
</pre></div>


<p>不难看到，我们的语料库里，总共有 13180 个文档，其中分成 20 个类别。接着，我们需要把这些文档全部转换为由 TF-IDF 表达的权重信息构成的向量：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.feature_extraction.text</span> <span style="color: #AA22FF; font-weight: bold">import</span> TfidfVectorizer

<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;vectorizing train dataset ...&quot;</span>)
t <span style="color: #666666">=</span> time()
vectorizer <span style="color: #666666">=</span> TfidfVectorizer(encoding<span style="color: #666666">=</span><span style="color: #BB4444">&#39;latin-1&#39;</span>)
X_train <span style="color: #666666">=</span> vectorizer<span style="color: #666666">.</span>fit_transform((d <span style="color: #AA22FF; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> news_train<span style="color: #666666">.</span>data))
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;n_samples: </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BB4444">, n_features: </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BB4444">&quot;</span> <span style="color: #666666">%</span> X_train<span style="color: #666666">.</span>shape)
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;number of non-zero features in sample [{0}]: {1}&quot;</span><span style="color: #666666">.</span>format(
    news_train<span style="color: #666666">.</span>filenames[<span style="color: #666666">0</span>], X_train[<span style="color: #666666">0</span>]<span style="color: #666666">.</span>getnnz()))
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;done in {0} seconds&quot;</span><span style="color: #666666">.</span>format(time() <span style="color: #666666">-</span> t))
</pre></div>


<p>其中，<a href="http://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.TfidfVectorizer.html">TfidfVectorizer</a> 类是用来把所有的文档转换为矩阵，该矩阵每行都代表一个文档，一行中的每个元素代表一个对应的词语的重要性，词语的重要性由 TF-IDF 来表示。熟悉 scikit-learn API 的读者应该清楚，其 <code>fit_transform()</code> 方法是 <code>fit()</code> 和 <code>transform()</code> 合并起来。其中，<code>fit()</code> 会先完成语料库分析，提取词典等操作，<code>transform()</code> 会把对每篇文档转换为向量，最终构成一个矩阵，保存在 <code>X_train</code> 变量里。这段代码在笔者电脑上的输出为：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">vectorizing train dataset <span style="color: #666666">...</span>
n_samples: <span style="color: #666666">13180</span>, n_features: <span style="color: #666666">130274</span>
number of non<span style="color: #666666">-</span>zero features <span style="color: #AA22FF; font-weight: bold">in</span> sample
  [datasets<span style="color: #666666">/</span>mlcomp<span style="color: #666666">/379/</span>train<span style="color: #666666">/</span>talk<span style="color: #666666">.</span>politics<span style="color: #666666">.</span>misc<span style="color: #666666">/17860-178992</span>]: <span style="color: #666666">108</span>
done <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">4.15024495125</span> seconds
</pre></div>


<p>由程序的输出，我们可以知道，我们的词典总共有 130274 个词语，即每篇文档都可转换为一个 130274 维的向量（这是一个巨大的向量）。第一篇文档中，只有 108 个非零元素，即这篇文章由 108 个单词组成，其单词数大于等于 108 个（因为有些词可出现多次）。在这篇文档中出现的这 108 个单词的 TF-IDF 值会被计算出来，并保存在向量中的指定位置上。<code>X_train</code> 是一个维度为 13180 x 130274 的稀疏矩阵（这是一个巨稀疏的矩阵）。</p>
<h2 id="3">3 模型训练</h2>
<p>费了好些功夫，终于把文档数据转换为 scikit-learn 里典型的训练数据集矩阵：矩阵的每一行表示一个数据样本，矩阵的每一列表示一个特征。接着，我们可以直接使用 <code>MultinomialNB</code> 来对数据集进行训练：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.naive_bayes</span> <span style="color: #AA22FF; font-weight: bold">import</span> MultinomialNB

<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;traning models ...&quot;</span><span style="color: #666666">.</span>format(time() <span style="color: #666666">-</span> t))
t <span style="color: #666666">=</span> time()
y_train <span style="color: #666666">=</span> news_train<span style="color: #666666">.</span>target
clf <span style="color: #666666">=</span> MultinomialNB(alpha<span style="color: #666666">=0.0001</span>)
clf<span style="color: #666666">.</span>fit(X_train, y_train)
train_score <span style="color: #666666">=</span> clf<span style="color: #666666">.</span>score(X_train, y_train)
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;train score: {0}&quot;</span><span style="color: #666666">.</span>format(train_score))
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;done in {0} seconds&quot;</span><span style="color: #666666">.</span>format(time() <span style="color: #666666">-</span> t))
</pre></div>


<p>其中 <code>alpha</code> 表示平滑参数，其值越小，越容易造成过拟合，值太大，容易造成欠拟合。这段代码在笔者电脑上的输出为：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">traning models <span style="color: #666666">...</span>
train score: <span style="color: #666666">0.997875569044</span>
done <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0.274363040924</span> seconds
</pre></div>


<p>接着，我们加载测试数据集，并拿一篇文档来预测看看是否准确。测试数据集在 <code>~/code/datasets/mlcomp/379/test</code> 目录下，我们用上文介绍的相同的方法，先加载数据集：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;loading test dataset ...&quot;</span>)
t <span style="color: #666666">=</span> time()
news_test <span style="color: #666666">=</span> load_files(<span style="color: #BB4444">&#39;datasets/mlcomp/379/test&#39;</span>)
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;summary: {0} documents in {1} categories.&quot;</span><span style="color: #666666">.</span>format(
    <span style="color: #AA22FF">len</span>(news_test<span style="color: #666666">.</span>data), <span style="color: #AA22FF">len</span>(news_test<span style="color: #666666">.</span>target_names)))
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;done in {0} seconds&quot;</span><span style="color: #666666">.</span>format(time() <span style="color: #666666">-</span> t))
</pre></div>


<p>在笔者的电脑上的输出为：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">loading test dataset <span style="color: #666666">...</span>
summary: <span style="color: #666666">5648</span> documents <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">20</span> categories<span style="color: #666666">.</span>
done <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0.117918014526</span> seconds
</pre></div>


<p>可见，我们的测试数据集总共有 5648 篇文档。接着，我们把文档向量化：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;vectorizing test dataset ...&quot;</span>)
t <span style="color: #666666">=</span> time()
X_test <span style="color: #666666">=</span> vectorizer<span style="color: #666666">.</span>transform((d <span style="color: #AA22FF; font-weight: bold">for</span> d <span style="color: #AA22FF; font-weight: bold">in</span> news_test<span style="color: #666666">.</span>data))
y_test <span style="color: #666666">=</span> news_test<span style="color: #666666">.</span>target
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;n_samples: </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BB4444">, n_features: </span><span style="color: #BB6688; font-weight: bold">%d</span><span style="color: #BB4444">&quot;</span> <span style="color: #666666">%</span> X_test<span style="color: #666666">.</span>shape)
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;number of non-zero features in sample [{0}]: {1}&quot;</span><span style="color: #666666">.</span>format(
    news_test<span style="color: #666666">.</span>filenames[<span style="color: #666666">0</span>], X_test[<span style="color: #666666">0</span>]<span style="color: #666666">.</span>getnnz()))
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;done in </span><span style="color: #BB6688; font-weight: bold">%f</span><span style="color: #BB4444">s&quot;</span> <span style="color: #666666">%</span> (time() <span style="color: #666666">-</span> t))
</pre></div>


<p>这里需要注意，<code>vectorizer</code> 变量是我们处理训练数据集时用到的广本向量化的类 TfidfVectorizer 的实例，此处我们只需要调用 <code>transform()</code> 进行 TF-IDF 数值计算即可，不需要再调用 <code>fit()</code> 进行语料库分析了。这段代码在笔者电脑上的输出为：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">vectorizing test dataset <span style="color: #666666">...</span>
n_samples: <span style="color: #666666">5648</span>, n_features: <span style="color: #666666">130274</span>
number of non<span style="color: #666666">-</span>zero features <span style="color: #AA22FF; font-weight: bold">in</span> sample
    [datasets<span style="color: #666666">/</span>mlcomp<span style="color: #666666">/379/</span>test<span style="color: #666666">/</span>rec<span style="color: #666666">.</span>autos<span style="color: #666666">/7429-103268</span>]: <span style="color: #666666">61</span>
done <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">2.915759</span>s
</pre></div>


<p>这样，我们的测试数据集也转换为一个维度为 5648 x 130274 的稀疏矩阵。我们可以取测试数据集里第一篇文档初步验证一下，看看我们训练出来的模型能否正确地预测这个文档所属的类别：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">pred <span style="color: #666666">=</span> clf<span style="color: #666666">.</span>predict(X_test[<span style="color: #666666">0</span>])
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;predict: {0} is in category {1}&quot;</span><span style="color: #666666">.</span>format(
    news_test<span style="color: #666666">.</span>filenames[<span style="color: #666666">0</span>], news_test<span style="color: #666666">.</span>target_names[pred[<span style="color: #666666">0</span>]]))
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;actually: {0} is in category {1}&quot;</span><span style="color: #666666">.</span>format(
    news_test<span style="color: #666666">.</span>filenames[<span style="color: #666666">0</span>], news_test<span style="color: #666666">.</span>target_names[news_test<span style="color: #666666">.</span>target[<span style="color: #666666">0</span>]]))
</pre></div>


<p>这段代码在笔者电脑上的输出为：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">predict: datasets<span style="color: #666666">/</span>mlcomp<span style="color: #666666">/379/</span>test<span style="color: #666666">/</span>rec<span style="color: #666666">.</span>autos<span style="color: #666666">/7429-103268</span> <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">in</span> category rec<span style="color: #666666">.</span>autos
actually: datasets<span style="color: #666666">/</span>mlcomp<span style="color: #666666">/379/</span>test<span style="color: #666666">/</span>rec<span style="color: #666666">.</span>autos<span style="color: #666666">/7429-103268</span> <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">in</span> category rec<span style="color: #666666">.</span>autos
</pre></div>


<p>看来预测的和实际的是相符的。</p>
<h2 id="4">4 模型评价</h2>
<p>显然，我们不能通过一个样本的预测来评价模型的准确性。我们需要对模型有个全方位的评价，所幸 scikit-learn 软件包提供了全方位的模型评价工具。</p>
<p>首先，我们需要对测试数据集进行预测：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;predicting test dataset ...&quot;</span>)
t0 <span style="color: #666666">=</span> time()
pred <span style="color: #666666">=</span> clf<span style="color: #666666">.</span>predict(X_test)
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;done in </span><span style="color: #BB6688; font-weight: bold">%f</span><span style="color: #BB4444">s&quot;</span> <span style="color: #666666">%</span> (time() <span style="color: #666666">-</span> t0))
</pre></div>


<p>在笔者的电脑上输出：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">predicting test dataset <span style="color: #666666">...</span>
done <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #666666">0.090978</span>s
</pre></div>


<p>接着，我们使用 <code>classification_report()</code> 函数来查看一下针对每个类别的预测准确性：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.metrics</span> <span style="color: #AA22FF; font-weight: bold">import</span> classification_report

<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;classification report on test set for classifier:&quot;</span>)
<span style="color: #AA22FF; font-weight: bold">print</span>(clf)
<span style="color: #AA22FF; font-weight: bold">print</span>(classification_report(y_test, pred,
                            target_names<span style="color: #666666">=</span>news_test<span style="color: #666666">.</span>target_names))
</pre></div>


<p>在笔者电脑上的输出为：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">classification report on test <span style="color: #AA22FF">set</span> <span style="color: #AA22FF; font-weight: bold">for</span> classifier:
MultinomialNB(alpha<span style="color: #666666">=0.0001</span>, class_prior<span style="color: #666666">=</span><span style="color: #AA22FF">None</span>, fit_prior<span style="color: #666666">=</span><span style="color: #AA22FF">True</span>)
                          precision    recall  f1<span style="color: #666666">-</span>score   support

             alt<span style="color: #666666">.</span>atheism       <span style="color: #666666">0.90</span>      <span style="color: #666666">0.91</span>      <span style="color: #666666">0.91</span>       <span style="color: #666666">245</span>
           comp<span style="color: #666666">.</span>graphics       <span style="color: #666666">0.80</span>      <span style="color: #666666">0.90</span>      <span style="color: #666666">0.85</span>       <span style="color: #666666">298</span>
 comp<span style="color: #666666">.</span>os<span style="color: #666666">.</span>ms<span style="color: #666666">-</span>windows<span style="color: #666666">.</span>misc       <span style="color: #666666">0.82</span>      <span style="color: #666666">0.79</span>      <span style="color: #666666">0.80</span>       <span style="color: #666666">292</span>
comp<span style="color: #666666">.</span>sys<span style="color: #666666">.</span>ibm<span style="color: #666666">.</span>pc<span style="color: #666666">.</span>hardware       <span style="color: #666666">0.81</span>      <span style="color: #666666">0.80</span>      <span style="color: #666666">0.81</span>       <span style="color: #666666">301</span>
   comp<span style="color: #666666">.</span>sys<span style="color: #666666">.</span>mac<span style="color: #666666">.</span>hardware       <span style="color: #666666">0.90</span>      <span style="color: #666666">0.91</span>      <span style="color: #666666">0.91</span>       <span style="color: #666666">256</span>
          comp<span style="color: #666666">.</span>windows<span style="color: #666666">.</span>x       <span style="color: #666666">0.88</span>      <span style="color: #666666">0.88</span>      <span style="color: #666666">0.88</span>       <span style="color: #666666">297</span>
            misc<span style="color: #666666">.</span>forsale       <span style="color: #666666">0.87</span>      <span style="color: #666666">0.81</span>      <span style="color: #666666">0.84</span>       <span style="color: #666666">290</span>
               rec<span style="color: #666666">.</span>autos       <span style="color: #666666">0.92</span>      <span style="color: #666666">0.93</span>      <span style="color: #666666">0.92</span>       <span style="color: #666666">324</span>
         rec<span style="color: #666666">.</span>motorcycles       <span style="color: #666666">0.96</span>      <span style="color: #666666">0.96</span>      <span style="color: #666666">0.96</span>       <span style="color: #666666">294</span>
      rec<span style="color: #666666">.</span>sport<span style="color: #666666">.</span>baseball       <span style="color: #666666">0.97</span>      <span style="color: #666666">0.94</span>      <span style="color: #666666">0.96</span>       <span style="color: #666666">315</span>
        rec<span style="color: #666666">.</span>sport<span style="color: #666666">.</span>hockey       <span style="color: #666666">0.96</span>      <span style="color: #666666">0.99</span>      <span style="color: #666666">0.98</span>       <span style="color: #666666">302</span>
               sci<span style="color: #666666">.</span>crypt       <span style="color: #666666">0.95</span>      <span style="color: #666666">0.96</span>      <span style="color: #666666">0.95</span>       <span style="color: #666666">297</span>
         sci<span style="color: #666666">.</span>electronics       <span style="color: #666666">0.91</span>      <span style="color: #666666">0.85</span>      <span style="color: #666666">0.88</span>       <span style="color: #666666">313</span>
                 sci<span style="color: #666666">.</span>med       <span style="color: #666666">0.96</span>      <span style="color: #666666">0.96</span>      <span style="color: #666666">0.96</span>       <span style="color: #666666">277</span>
               sci<span style="color: #666666">.</span>space       <span style="color: #666666">0.94</span>      <span style="color: #666666">0.97</span>      <span style="color: #666666">0.96</span>       <span style="color: #666666">305</span>
  soc<span style="color: #666666">.</span>religion<span style="color: #666666">.</span>christian       <span style="color: #666666">0.93</span>      <span style="color: #666666">0.96</span>      <span style="color: #666666">0.94</span>       <span style="color: #666666">293</span>
      talk<span style="color: #666666">.</span>politics<span style="color: #666666">.</span>guns       <span style="color: #666666">0.91</span>      <span style="color: #666666">0.96</span>      <span style="color: #666666">0.93</span>       <span style="color: #666666">246</span>
   talk<span style="color: #666666">.</span>politics<span style="color: #666666">.</span>mideast       <span style="color: #666666">0.96</span>      <span style="color: #666666">0.98</span>      <span style="color: #666666">0.97</span>       <span style="color: #666666">296</span>
      talk<span style="color: #666666">.</span>politics<span style="color: #666666">.</span>misc       <span style="color: #666666">0.90</span>      <span style="color: #666666">0.90</span>      <span style="color: #666666">0.90</span>       <span style="color: #666666">236</span>
      talk<span style="color: #666666">.</span>religion<span style="color: #666666">.</span>misc       <span style="color: #666666">0.89</span>      <span style="color: #666666">0.78</span>      <span style="color: #666666">0.83</span>       <span style="color: #666666">171</span>

             avg <span style="color: #666666">/</span> total       <span style="color: #666666">0.91</span>      <span style="color: #666666">0.91</span>      <span style="color: #666666">0.91</span>      <span style="color: #666666">5648</span>
</pre></div>


<p>从输出可以看出来，针对每种类别，都统计了查准率，召回率和 F1-Score。对这些概念不熟悉的读者可参阅笔者的另外一篇博客<a href="http://blog.kamidox.com/evaluating-2.html">机器学习系统的设计与调优</a>。此外，我们还可以通过 <code>confusion_matrix()</code> 函数，来生成混淆矩阵，观察每种类别被错误分类的情况，比如，这些被错误分类的文档是被错误分类到哪些类别里的：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #AA22FF; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.metrics</span> <span style="color: #AA22FF; font-weight: bold">import</span> confusion_matrix

cm <span style="color: #666666">=</span> confusion_matrix(y_test, pred)
<span style="color: #AA22FF; font-weight: bold">print</span>(<span style="color: #BB4444">&quot;confusion matrix:&quot;</span>)
<span style="color: #AA22FF; font-weight: bold">print</span>(cm)
</pre></div>


<p>在笔者电脑上的输出为：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%">confusion matrix:
[[<span style="color: #666666">224</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">5</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>  <span style="color: #666666">13</span>]
 [  <span style="color: #666666">1</span> <span style="color: #666666">267</span>   <span style="color: #666666">5</span>   <span style="color: #666666">5</span>   <span style="color: #666666">2</span>   <span style="color: #666666">8</span>   <span style="color: #666666">1</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">3</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">1</span>  <span style="color: #666666">13</span> <span style="color: #666666">230</span>  <span style="color: #666666">24</span>   <span style="color: #666666">4</span>  <span style="color: #666666">10</span>   <span style="color: #666666">5</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>   <span style="color: #666666">9</span>  <span style="color: #666666">21</span> <span style="color: #666666">242</span>   <span style="color: #666666">7</span>   <span style="color: #666666">2</span>  <span style="color: #666666">10</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">1</span>   <span style="color: #666666">7</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">5</span>   <span style="color: #666666">5</span> <span style="color: #666666">233</span>   <span style="color: #666666">2</span>   <span style="color: #666666">2</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">3</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>  <span style="color: #666666">20</span>   <span style="color: #666666">6</span>   <span style="color: #666666">3</span>   <span style="color: #666666">1</span> <span style="color: #666666">260</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">5</span>  <span style="color: #666666">12</span>   <span style="color: #666666">3</span>   <span style="color: #666666">1</span> <span style="color: #666666">235</span>  <span style="color: #666666">10</span>   <span style="color: #666666">2</span>   <span style="color: #666666">3</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">7</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">4</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">8</span> <span style="color: #666666">300</span>   <span style="color: #666666">4</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">2</span>   <span style="color: #666666">3</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">2</span>   <span style="color: #666666">3</span> <span style="color: #666666">283</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">1</span>]
 [  <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">2</span>   <span style="color: #666666">0</span> <span style="color: #666666">297</span>   <span style="color: #666666">8</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">2</span> <span style="color: #666666">298</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">2</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span> <span style="color: #666666">284</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">2</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>  <span style="color: #666666">11</span>   <span style="color: #666666">3</span>   <span style="color: #666666">5</span>   <span style="color: #666666">4</span>   <span style="color: #666666">2</span>   <span style="color: #666666">4</span>   <span style="color: #666666">5</span>   <span style="color: #666666">1</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">4</span> <span style="color: #666666">266</span>   <span style="color: #666666">1</span>   <span style="color: #666666">4</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">1</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span> <span style="color: #666666">266</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">0</span>   <span style="color: #666666">3</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span> <span style="color: #666666">296</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">3</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">1</span> <span style="color: #666666">280</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">1</span>   <span style="color: #666666">2</span>]
 [  <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">2</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span> <span style="color: #666666">236</span>   <span style="color: #666666">1</span>   <span style="color: #666666">4</span>   <span style="color: #666666">1</span>]
 [  <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">3</span>   <span style="color: #666666">0</span> <span style="color: #666666">290</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>]
 [  <span style="color: #666666">2</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">1</span>  <span style="color: #666666">10</span>   <span style="color: #666666">7</span> <span style="color: #666666">212</span>   <span style="color: #666666">0</span>]
 [ <span style="color: #666666">16</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>   <span style="color: #666666">0</span>  <span style="color: #666666">12</span>   <span style="color: #666666">4</span>   <span style="color: #666666">1</span>   <span style="color: #666666">4</span> <span style="color: #666666">134</span>]]
</pre></div>


<p>从第一行数据可以看出来，类别 0 (alt.atheism) 的文档，有 13 个文档被错误地分类到类别 19 (talk.religion.misc) 里。当然，我们还可以把混淆矩阵进行数据可视化处理：</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008800; font-style: italic"># Show confusion matrix</span>
<span style="color: #AA22FF; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #AA22FF; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>

plt<span style="color: #666666">.</span>figure(figsize<span style="color: #666666">=</span>(<span style="color: #666666">8</span>, <span style="color: #666666">8</span>), dpi<span style="color: #666666">=144</span>)
plt<span style="color: #666666">.</span>title(<span style="color: #BB4444">&#39;Confusion matrix of the classifier&#39;</span>)
ax <span style="color: #666666">=</span> plt<span style="color: #666666">.</span>gca()
ax<span style="color: #666666">.</span>spines[<span style="color: #BB4444">&#39;right&#39;</span>]<span style="color: #666666">.</span>set_color(<span style="color: #BB4444">&#39;none&#39;</span>)
ax<span style="color: #666666">.</span>spines[<span style="color: #BB4444">&#39;top&#39;</span>]<span style="color: #666666">.</span>set_color(<span style="color: #BB4444">&#39;none&#39;</span>)
ax<span style="color: #666666">.</span>spines[<span style="color: #BB4444">&#39;bottom&#39;</span>]<span style="color: #666666">.</span>set_color(<span style="color: #BB4444">&#39;none&#39;</span>)
ax<span style="color: #666666">.</span>spines[<span style="color: #BB4444">&#39;left&#39;</span>]<span style="color: #666666">.</span>set_color(<span style="color: #BB4444">&#39;none&#39;</span>)
ax<span style="color: #666666">.</span>xaxis<span style="color: #666666">.</span>set_ticks_position(<span style="color: #BB4444">&#39;none&#39;</span>)
ax<span style="color: #666666">.</span>yaxis<span style="color: #666666">.</span>set_ticks_position(<span style="color: #BB4444">&#39;none&#39;</span>)
ax<span style="color: #666666">.</span>set_xticklabels([])
ax<span style="color: #666666">.</span>set_yticklabels([])
plt<span style="color: #666666">.</span>matshow(cm, fignum<span style="color: #666666">=1</span>, cmap<span style="color: #666666">=</span><span style="color: #BB4444">&#39;gray&#39;</span>)
plt<span style="color: #666666">.</span>colorbar()
plt<span style="color: #666666">.</span>show()
</pre></div>


<p>在笔者电脑上的输出如下图所示:</p>
<p><img alt="混淆矩阵" src="https://raw.githubusercontent.com/kamidox/blogs/master/images/ch09.02_confusion_matrix.png" /></p>
<p>除对角线外，其他地方颜色越浅，说明此处错误越多。通过这些数据，我们可以详细分析样本数据，找出为什么某种类别会被错误地分类到另外一种类别里，从而进一步优化模型。</p>
<h2 id="5">5 参数选择</h2>
<p><code>MultinomialNB</code> 有一个重要的参数是 alpha ，用来控制模型拟合时的平滑度。我们选择了 0.0001 这个值。实际上，有一个更科学的方法，是利用 scikit-learn 的 <code>sklearn.model_selection.GridSearchCV</code> 来进行自动选择。即我们可以设置一个 alpha 参数的范围，然后让用代码选择出一个在这个范围内最优的参数值。感兴趣的朋友可以阅读 <a href="http://scikit-learn.org/stable/modules/generated/sklearn.grid_search.GridSearchCV.html">GridSearchCV</a> 的文档偿试一下。</p>
<p>(完)</p>
	<hr/>
	<h6>Post by <a href="./author/joey-huang.html">Joey Huang</a> under <a href="./category/ml.html">ml</a> on 2017-05-07(Sunday) 23:43. Tags: <a href="./tag/machine-learning.html">machine-learning</a>, </h6>
</article>

<hr/>
<div class="row">
	<div class="small-12 columns">
		<h3>Comments</h3>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_shortname = 'kamidox';
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
</div>
						</div>
						<!-- End Main Content -->
						<!-- Sidebar -->
						<aside class="medium-3 hide-for-small-only columns">
							<div class="panel">
								<h5>Places</h5>
								<ul class="side-nav">
										<li><a href="http://blog.kamidox.com/feeds/rss.xml" rel="alternate">RSS Feed</a></li>

								</ul>
							</div>


							<div class="panel">
								<h5>Categories</h5>
								<ul class="side-nav">
										<li><a href="./category/android.html">android</a></li>
										<li><a href="./category/essay.html">essay</a></li>
										<li><a href="./category/flask.html">flask</a></li>
										<li><a href="./category/ml.html">ml</a></li>
										<li><a href="./category/nlp.html">nlp</a></li>
										<li><a href="./category/python.html">python</a></li>
										<li><a href="./category/tools.html">tools</a></li>
										<li><a href="./category/weapp.html">weapp</a></li>
										<li><a href="./category/web.html">web</a></li>
										<li><a href="./category/werkzeug.html">werkzeug</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Tags</h5>
								<ul class="tag-cloud">
										<li class="tag-4"><a href="./tag/ebook.html">ebook</a></li>
										<li class="tag-1"><a href="./tag/machine-learning.html">machine-learning</a></li>
										<li class="tag-2"><a href="./tag/markdown.html">markdown</a></li>
										<li class="tag-4"><a href="./tag/wekzeug.html">wekzeug</a></li>
										<li class="tag-2"><a href="./tag/weapp.html">weapp</a></li>
										<li class="tag-1"><a href="./tag/thought.html">thought</a></li>
										<li class="tag-4"><a href="./tag/contacts-provider.html">contacts provider</a></li>
										<li class="tag-4"><a href="./tag/decorator.html">decorator</a></li>
										<li class="tag-2"><a href="./tag/flask.html">flask</a></li>
										<li class="tag-4"><a href="./tag/miui.html">miui</a></li>
										<li class="tag-4"><a href="./tag/contacts.html">contacts</a></li>
										<li class="tag-4"><a href="./tag/react.html">react</a></li>
										<li class="tag-4"><a href="./tag/socketserver.html">SocketServer</a></li>
										<li class="tag-3"><a href="./tag/sublime.html">sublime</a></li>
										<li class="tag-4"><a href="./tag/github.html">github</a></li>
										<li class="tag-1"><a href="./tag/python.html">python</a></li>
										<li class="tag-4"><a href="./tag/uml.html">uml</a></li>
										<li class="tag-2"><a href="./tag/tools.html">tools</a></li>
										<li class="tag-3"><a href="./tag/web.html">web</a></li>
										<li class="tag-2"><a href="./tag/android.html">android</a></li>
										<li class="tag-3"><a href="./tag/pelican.html">pelican</a></li>
										<li class="tag-4"><a href="./tag/patchrom.html">patchrom</a></li>
										<li class="tag-4"><a href="./tag/nlp.html">nlp</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Monthly Archives</h5>
								<ul class="side-nav">
											<li><a href="/posts/2018/03/index.html">March 2018 (1)</a></li>
											<li><a href="/posts/2017/05/index.html">May 2017 (2)</a></li>
											<li><a href="/posts/2017/04/index.html">April 2017 (1)</a></li>
											<li><a href="/posts/2017/02/index.html">February 2017 (1)</a></li>
											<li><a href="/posts/2017/01/index.html">January 2017 (1)</a></li>
											<li><a href="/posts/2016/12/index.html">December 2016 (2)</a></li>
											<li><a href="/posts/2016/11/index.html">November 2016 (3)</a></li>
											<li><a href="/posts/2016/10/index.html">October 2016 (1)</a></li>
											<li><a href="/posts/2016/09/index.html">September 2016 (1)</a></li>
											<li><a href="/posts/2016/03/index.html">March 2016 (2)</a></li>
											<li><a href="/posts/2016/02/index.html">February 2016 (2)</a></li>
											<li><a href="/posts/2016/01/index.html">January 2016 (2)</a></li>
											<li><a href="/posts/2015/12/index.html">December 2015 (10)</a></li>
											<li><a href="/posts/2015/11/index.html">November 2015 (6)</a></li>
											<li><a href="/posts/2015/10/index.html">October 2015 (2)</a></li>
											<li><a href="/posts/2015/09/index.html">September 2015 (7)</a></li>
											<li><a href="/posts/2015/08/index.html">August 2015 (1)</a></li>
											<li><a href="/posts/2015/07/index.html">July 2015 (1)</a></li>
											<li><a href="/posts/2015/05/index.html">May 2015 (1)</a></li>
											<li><a href="/posts/2015/04/index.html">April 2015 (1)</a></li>
											<li><a href="/posts/2015/03/index.html">March 2015 (3)</a></li>
											<li><a href="/posts/2015/02/index.html">February 2015 (2)</a></li>
											<li><a href="/posts/2015/01/index.html">January 2015 (2)</a></li>
											<li><a href="/posts/2014/12/index.html">December 2014 (3)</a></li>
											<li><a href="/posts/2014/11/index.html">November 2014 (4)</a></li>
											<li><a href="/posts/2014/10/index.html">October 2014 (6)</a></li>
											<li><a href="/posts/2014/09/index.html">September 2014 (1)</a></li>
											<li><a href="/posts/2014/07/index.html">July 2014 (1)</a></li>
								</ul>
							</div>

						</aside>
						<!-- End Sidebar -->
					</div>

					<!-- Footer -->
					<footer class="row">
						<div class="medium-9 small-12">
							<hr/>
							<p class="text-center">Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://foundation.zurb.com/">Zurb Foundation</a>. Theme by <a href="http://hamaluik.com">Kenton Hamaluik</a>.
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253471695'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1253471695%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
							</p>
						</div>
					</footer>
					<!-- End Footer -->
				</section>
				<a class="exit-off-canvas"></a>
			</div><!--off-canvas inner-->
		</div><!--off-canvas wrap-->

		<script src="./theme/js/jquery.js"></script>
		<script src="./theme/js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>
	</body>
</html>